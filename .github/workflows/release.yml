name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  GITHUB_USER: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}

jobs:
  build:
    name: Build Firmware for Release
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        board: [esp32_dev, esp32s3_dev]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Cache Arduino CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: ${{ runner.os }}-arduino-cli-esp32-${{ hashFiles('**/build.ps1', 'common/**') }}
          restore-keys: |
            ${{ runner.os }}-arduino-cli-esp32-
      
      - name: Install Arduino CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=/usr/local/bin sh -s 1.3.1
          arduino-cli version
      
      - name: Install ESP32 core and libraries
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set library.enable_unsafe_install true
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@3.3.2
          arduino-cli lib install "PubSubClient"
      
      - name: Build firmware
        run: |
          chmod +x build.sh
          ./build.sh ${{ matrix.board }}
          
          # Copy versioned binaries for release
          cd build/${{ matrix.board }}
          cp ${{ matrix.board }}.ino.bin ${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bin
          cp ${{ matrix.board }}.ino.bootloader.bin ${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bootloader.bin
          cp ${{ matrix.board }}.ino.partitions.bin ${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.partitions.bin
      
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}-${{ steps.get_version.outputs.version }}
          path: |
            build/${{ matrix.board }}/${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bin
            build/${{ matrix.board }}/${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bootloader.bin
            build/${{ matrix.board }}/${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.partitions.bin
          retention-days: 90
          if-no-files-found: error

  release:
    name: Create GitHub Release and Deploy Flasher
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare artifacts for release
        run: |
          echo "Downloaded artifacts:"
          ls -lR artifacts/
          
          # Move binaries to root of artifacts for easier access
          find artifacts/ -name "*.bin" -type f -exec cp {} artifacts/ \;
          
          echo ""
          echo "Binaries ready for release:"
          ls -l artifacts/*.bin
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.tag }}
          body: |
            ## ESP32 Multi-Board Template ${{ steps.get_version.outputs.tag }}
            
            ### üéØ Flash Firmware via Web Browser
            Visit: **[${{ env.GITHUB_USER }}.github.io/${{ env.GITHUB_REPO }}/](https://${{ env.GITHUB_USER }}.github.io/${{ env.GITHUB_REPO }}/)**
            
            ### üì¶ Supported Boards
            - **ESP32 DevKit V1** - Standard ESP32 development board
            - **ESP32-S3 DevKit** - ESP32-S3 with USB OTG
            
            ### üîß Manual Installation
            Download the appropriate `.bin` file below and flash using:
            - Arduino IDE
            - Platform.IO
            - esptool.py
            
            See [README.md](README.md) for detailed instructions.
          files: artifacts/*.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate web flasher manifests
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          set -euo pipefail

          chmod +x scripts/generate_manifests.sh
          scripts/generate_manifests.sh "${TAG}" artifacts . "${{ env.GITHUB_USER }}" "${{ env.GITHUB_REPO }}"

          echo "Generated manifests:"
          ls -l manifest_*.json

      - name: Generate latest.json metadata
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          set -euo pipefail

          chmod +x scripts/generate_latest_json.sh
          scripts/generate_latest_json.sh "${TAG}" artifacts latest.json "${{ env.GITHUB_USER }}" "${{ env.GITHUB_REPO }}"

          echo "Generated latest.json:"
          cat latest.json      - name: Commit binaries and manifests to gh-pages branch
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          set -euo pipefail
          
          # Configure git
          git config user.email "actions@github.com"
          git config user.name "GitHub Action"
          
          # Save the generated manifests and binaries
          mkdir -p /tmp/flasher-release
          cp manifest_*.json latest.json /tmp/flasher-release/
          
          # Copy all binaries
          echo "Copying binaries from artifacts/:"
          ls -l artifacts/*.bin
          cp -v artifacts/*.bin /tmp/flasher-release/
          
          echo ""
          echo "Binaries staged for commit:"
          ls -l /tmp/flasher-release/
          
          # Fetch and checkout gh-pages branch (create if doesn't exist)
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git checkout -f gh-pages || git checkout --orphan gh-pages
          
          # Clean working directory
          git rm -rf . || true

          # Create firmware directory
          mkdir -p firmware/${TAG}

          # Copy binaries to versioned directory
          cp -v /tmp/flasher-release/*.bin firmware/${TAG}/

          # Copy manifests to root
          cp -v /tmp/flasher-release/manifest_*.json /tmp/flasher-release/latest.json .

          # Copy flasher HTML/CSS/JS from main branch to root
          git checkout origin/main -- flasher/index.html flasher/app.js flasher/styles.css flasher/README.md || true
          mv flasher/index.html flasher/app.js flasher/styles.css flasher/README.md . || true
          rmdir flasher || true

          echo ""
          echo "Files in gh-pages root after copy:"
          ls -lR .

          # Add all changes
          git add .          echo ""
          echo "Git status after add:"
          git status
          
          # Commit and push if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Deploy flasher for ${TAG} [skip ci]" \
                       -m "- Add firmware binaries for ${TAG}" \
                       -m "- Update manifests for ${TAG}"
            git push origin gh-pages
            echo "‚úÖ Flasher deployed to gh-pages branch"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi
