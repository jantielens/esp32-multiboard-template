name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  GITHUB_USER: ${{ github.repository_owner }}
  GITHUB_REPO: ${{ github.event.repository.name }}

jobs:
  discover:
    name: Discover Boards
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.discover-boards.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Discover boards dynamically
        id: discover-boards
        uses: ./.github/actions/discover-boards

  build:
    name: Build Firmware for Release
    runs-on: ubuntu-latest
    needs: discover
    
    strategy:
      matrix:
        board: ${{ fromJSON(needs.discover.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Setup ESP32 build environment
        uses: ./.github/actions/setup-build
      
      - name: Build firmware
        run: |
          chmod +x build.sh
          ./build.sh ${{ matrix.board }}
          
          # Copy versioned binaries for release
          cd build/${{ matrix.board }}
          cp ${{ matrix.board }}.ino.bin ${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bin
          cp ${{ matrix.board }}.ino.bootloader.bin ${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bootloader.bin
          cp ${{ matrix.board }}.ino.partitions.bin ${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.partitions.bin
      
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}-${{ steps.get_version.outputs.version }}
          path: |
            build/${{ matrix.board }}/${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bin
            build/${{ matrix.board }}/${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.bootloader.bin
            build/${{ matrix.board }}/${{ matrix.board }}-v${{ steps.get_version.outputs.version }}.partitions.bin
          retention-days: 90
          if-no-files-found: error

  release:
    name: Create GitHub Release and Deploy Flasher
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare artifacts for release
        run: |
          echo "Downloaded artifacts:"
          ls -lR artifacts/
          
          # Move binaries to root of artifacts for easier access
          find artifacts/ -name "*.bin" -type f -exec cp {} artifacts/ \;
          
          echo ""
          echo "Binaries ready for release:"
          ls -l artifacts/*.bin
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.tag }}
          body: |
            ## ESP32 Multi-Board Template ${{ steps.get_version.outputs.tag }}
            
            ### üéØ Flash Firmware via Web Browser
            Visit: **[${{ env.GITHUB_USER }}.github.io/${{ env.GITHUB_REPO }}/](https://${{ env.GITHUB_USER }}.github.io/${{ env.GITHUB_REPO }}/)**
            
            ### üì¶ Supported Boards
            - **ESP32 DevKit V1** - Standard ESP32 development board
            - **ESP32-S3 DevKit** - ESP32-S3 with USB OTG
            
            ### üîß Manual Installation
            Download the appropriate `.bin` file below and flash using:
            - Arduino IDE
            - Platform.IO
            - esptool.py
            
            See [README.md](README.md) for detailed instructions.
          files: artifacts/*.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure jq is installed
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate web flasher manifests
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          set -euo pipefail

          chmod +x scripts/generate_manifests.sh
          scripts/generate_manifests.sh "${TAG}" artifacts . "${{ env.GITHUB_USER }}" "${{ env.GITHUB_REPO }}"

          echo "Generated manifests:"
          ls -l manifest_*.json

      - name: Generate latest.json metadata
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          set -euo pipefail

          chmod +x scripts/generate_latest_json.sh
          scripts/generate_latest_json.sh "${TAG}" artifacts latest.json "${{ env.GITHUB_USER }}" "${{ env.GITHUB_REPO }}"

          echo "Generated latest.json:"
          cat latest.json

      - name: Commit binaries and manifests to gh-pages branch
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          
          # Configure git
          git config user.email "actions@github.com"
          git config user.name "GitHub Action"
          
          # Fetch repository description from GitHub API
          echo "Fetching repository description from GitHub..."
          REPO_DESCRIPTION=$(curl -s "https://api.github.com/repos/${GITHUB_REPOSITORY}" | jq -r '.description // ""')
          echo "Repository description: $REPO_DESCRIPTION"
          
          # Generate config.js from package.json + GitHub context
          echo "Generating config.js..."
          jq -r --arg repo "$GITHUB_REPOSITORY" --arg desc "$REPO_DESCRIPTION" '
            "/**\n * Project Configuration\n * \n * Auto-generated from package.json and GitHub repository during deployment.\n * DO NOT EDIT - This file is generated automatically.\n */\nwindow.PROJECT_CONFIG = {\n  displayName: \"\(.displayName // .name)\",\n  displayNameShort: \"\(.displayNameShort // .displayName // .name)\",\n  repository: \"\($repo)\",\n  description: \"\($desc)\"\n};"
          ' package.json > /tmp/config.js
          
          echo ""
          echo "Generated config.js:"
          cat /tmp/config.js
          
          # Save the generated manifests and binaries
          mkdir -p /tmp/flasher-release
          cp manifest_*.json latest.json /tmp/flasher-release/
          cp /tmp/config.js /tmp/flasher-release/
          
          # Copy all binaries
          echo "Copying binaries from artifacts/:"
          ls -l artifacts/*.bin
          cp -v artifacts/*.bin /tmp/flasher-release/
          
          echo ""
          echo "Binaries staged for commit:"
          ls -l /tmp/flasher-release/
          
          # Fetch and checkout gh-pages branch (create if doesn't exist)
          git fetch origin gh-pages || git checkout --orphan gh-pages
          git checkout -f gh-pages || git checkout --orphan gh-pages

          # Clean working directory
          git rm -rf . || true

          # Fetch main branch to get flasher files
          git fetch origin main

          # Create firmware directory
          mkdir -p firmware/${TAG}

          # Copy binaries to versioned directory
          cp -v /tmp/flasher-release/*.bin firmware/${TAG}/

          # Copy manifests to root
          cp -v /tmp/flasher-release/manifest_*.json /tmp/flasher-release/latest.json .

          # Copy generated config.js
          cp -v /tmp/flasher-release/config.js .
          
          # Copy flasher HTML/CSS/JS from main branch to root
          git show origin/main:flasher/index.html > index.html || true
          git show origin/main:flasher/app.js > app.js || true
          git show origin/main:flasher/styles.css > styles.css || true
          git show origin/main:flasher/README.md > README.md || true

          echo ""
          echo "Files in gh-pages root after copy:"
          ls -lR .

          # Add all changes
          git add .

          echo ""
          echo "Git status after add:"
          git status
          
          # Commit and push if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Deploy flasher for ${TAG} [skip ci]" \
                       -m "- Add firmware binaries for ${TAG}" \
                       -m "- Update manifests for ${TAG}"
            git push origin gh-pages
            echo "‚úÖ Flasher deployed to gh-pages branch"
          else
            echo "‚ÑπÔ∏è  No changes to commit"
          fi
